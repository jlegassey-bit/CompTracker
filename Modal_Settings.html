<style>
  .settings-tab-content {
    padding: 20px;
  }
  .settings-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  .settings-card-header {
    background: linear-gradient(90deg, #0b2a4a 0%, #0f3b67 50%, #164b83 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .settings-card-body {
    padding: 20px;
  }
  .item-card {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
  }
  .item-card:hover {
    background: #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .contact-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
  }
  .contact-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 16px;
  }
  .contact-box h6 {
    color: #0f3b67;
    font-weight: 600;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #0f3b67;
  }
  .table-settings {
    font-size: 0.9rem;
  }
  .table-settings th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 600;
    border-top: none;
  }
</style>

<!-- Add Document Type Modal -->
<div class="modal fade" id="addDocumentTypeModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Document Type</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <form id="addDocumentTypeForm">
          <div class="form-group">
            <label for="add_docTypeName">Document Type *</label>
            <input type="text" class="form-control" id="add_docTypeName" required placeholder="e.g., Medical Report">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="saveDocumentTypeAdd()">Add Type</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" data-backdrop="static">
  <div class="modal-dialog modal-xl" style="max-width: 95%;">
    <div class="modal-content">
      
      <div class="modal-header bg-dark text-white py-2">
        <h5 class="modal-title"><i class="fas fa-cog mr-2"></i>System Settings</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      
      <div class="modal-body p-0">
        <div class="row no-gutters" style="min-height: 70vh;">
          
          <!-- Left Sidebar Navigation -->
          <div class="col-md-2 bg-light border-right">
            <div class="nav flex-column nav-pills p-3 sticky-top" style="top:0; z-index:1;" id="settingsTabs" role="tablist">
              <a class="nav-link active" data-toggle="pill" href="#tab-admins">
                <i class="fas fa-user-shield mr-2"></i>Admins
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-departments">
                <i class="fas fa-building mr-2"></i>Departments
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-worklocations">
                <i class="fas fa-map-marker-alt mr-2"></i>Work Locations
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-causes">
                <i class="fas fa-exclamation-triangle mr-2"></i>Injury Causes
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-treatments">
                <i class="fas fa-first-aid mr-2"></i>Treatments
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-bodyparts">
                <i class="fas fa-user-injured mr-2"></i>Body Parts
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-doctypes">
                <i class="fas fa-file-alt mr-2"></i>Document Types
              </a>
              <a class="nav-link" data-toggle="pill" href="#tab-providers">
                <i class="fas fa-hospital mr-2"></i>Providers
              </a>
            </div>
          </div>

          <!-- Right Content Area -->
          <div class="col-md-10">
            <div class="tab-content settings-tab-content">
              
              <!-- ADMINS TAB -->
              <div class="tab-pane fade show active" id="tab-admins">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">System Administrators</h5>
                  <button class="btn btn-sm btn-success" onclick="addAdminUI()">
                    <i class="fas fa-plus mr-1"></i> Add Admin
                  </button>
                </div>
                <table class="table table-settings table-hover bg-white" id="tblAdmins">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Department</th>
                      <th>Title</th>
                      <th width="80"></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <!-- DEPARTMENTS TAB -->
              <div class="tab-pane fade" id="tab-departments">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Departments</h5>
                  <button class="btn btn-sm btn-success" onclick="addDeptUI()">
                    <i class="fas fa-plus mr-1"></i> Add Department
                  </button>
                </div>
                <div id="deptList"></div>
              </div>

              <!-- WORK LOCATIONS TAB -->
              <div class="tab-pane fade" id="tab-worklocations">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Work Locations</h5>
                  <button class="btn btn-sm btn-success" onclick="addWorkLocUI()">
                    <i class="fas fa-plus mr-1"></i> Add Location
                  </button>
                </div>
                <table class="table table-settings table-hover bg-white" id="tblWorkLocs">
                  <thead>
                    <tr>
                      <th>Work Location</th>
                      <th>Department</th>
                      <th>Last Updated</th>
                      <th width="80"></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <!-- CAUSES TAB -->
              <div class="tab-pane fade" id="tab-causes">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Primary Causes of Injury</h5>
                  <button class="btn btn-sm btn-success" onclick="addCauseUI()">
                    <i class="fas fa-plus mr-1"></i> Add Cause
                  </button>
                </div>
                <div id="causeList"></div>
              </div>

              <!-- TREATMENTS TAB -->
              <div class="tab-pane fade" id="tab-treatments">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Treatment Types</h5>
                  <button class="btn btn-sm btn-success" onclick="addTreatmentUI()">
                    <i class="fas fa-plus mr-1"></i> Add Treatment
                  </button>
                </div>
                <div id="treatmentList"></div>
              </div>

              <!-- BODY PARTS TAB -->
              <div class="tab-pane fade" id="tab-bodyparts">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Body Parts</h5>
                  <button class="btn btn-sm btn-success" onclick="addBodyPartUI()">
                    <i class="fas fa-plus mr-1"></i> Add Body Part
                  </button>
                </div>
                <div id="bodyPartList"></div>
              </div>
                <!-- DOCUMENT TYPES TAB -->
              <div class="tab-pane fade" id="tab-doctypes">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Document Types</h5>
                  <button class="btn btn-sm btn-success" onclick="addDocumentTypeUI()">
                    <i class="fas fa-plus mr-1"></i> Add Type
                  </button>
                </div>
                <div id="documentTypeList"></div>
              </div>
              <!-- PROVIDERS TAB -->
              <div class="tab-pane fade" id="tab-providers">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Treatment Providers</h5>
                  <button class="btn btn-sm btn-success" onclick="addProviderUI()">
                    <i class="fas fa-plus mr-1"></i> Add Provider
                  </button>
                </div>
                <table class="table table-settings table-hover bg-white" id="tblProviders">
                  <thead>
                    <tr>
                      <th>Provider Name</th>
                      <th>Address</th>
                      <th>Phone</th>
                      <th>Hours Summary</th>
                      <th width="80"></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
          </div>

        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
 function loadSettings() {
    loadAdmins();
    loadDepartments();
    loadWorkLocs();
    loadCauses();
    loadTreatments();
    loadBodyParts();
    loadDocumentTypes();
    loadProviders();
  }

  // --- ADMINS ---
  function loadAdmins() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(a => {
        html += `<tr>
          <td>${esc(a.name)}</td>
          <td>${esc(a.email)}</td>
          <td>${esc(a.department)}</td>
          <td>${esc(a.title)}</td>
          <td>
            <button class="btn btn-xs btn-outline-danger" onclick="delAdmin(${a.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`;
      });
      $('#tblAdmins tbody').html(html || '<tr><td colspan="5" class="text-center text-muted">No admins found</td></tr>');
    }).settingsGetAdmins(APP.token);
  }

  function addAdminUI() {
  google.script.run.withSuccessHandler(function(res) {
    var deptOptions = '';
    
    if (res.success && res.rows && res.rows.length > 0) {
      res.rows.forEach(function(dept) {
        deptOptions += `<option value="${dept.department}">${dept.department}</option>`;
      });
    } else {
      deptOptions = '<option value="">No departments available</option>';
    }
    
    Swal.fire({
      title: 'Add New Admin',
      width: '600px',
      html: `
        <div class="text-left">
          <div class="form-group mb-3">
            <label class="font-weight-bold small d-block mb-1">Full Name *</label>
            <input id="adminName" type="text" class="form-control" placeholder="Enter full name">
          </div>
          
          <div class="form-group mb-3">
            <label class="font-weight-bold small d-block mb-1">Email Address *</label>
            <input id="adminEmail" type="text" class="form-control" placeholder="user@portlandmaine.gov">
            <small class="text-muted">Must be a valid City of Portland email</small>
          </div>
          
          <div class="form-group mb-3">
            <label class="font-weight-bold small d-block mb-1">Department *</label>
            <select id="adminDept" class="form-control">
              <option value="" disabled selected>Select Department...</option>
              ${deptOptions}
            </select>
          </div>
          
          <div class="form-group mb-3">
            <label class="font-weight-bold small d-block mb-1">Title/Position</label>
            <input id="adminTitle" type="text" class="form-control" placeholder="e.g., Safety Officer, HR Manager">
          </div>
          
          <div class="alert alert-info small mb-0">
            <i class="fas fa-info-circle mr-1"></i>
            New admin will have full access to the FROI management system.
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Add Admin',
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#6c757d',
      focusConfirm: false,
      preConfirm: () => {
        var name = $('#adminName').val().trim();
        var email = $('#adminEmail').val().trim();
        var dept = $('#adminDept').val();
        
        if (!name) {
          Swal.showValidationMessage('Name is required');
          return false;
        }
        if (!email) {
          Swal.showValidationMessage('Email is required');
          return false;
        }
        if (!dept) {
          Swal.showValidationMessage('Department is required');
          return false;
        }
        
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          Swal.showValidationMessage('Please enter a valid email address');
          return false;
        }
        
        return {
          name: name,
          email: email,
          department: dept,
          title: $('#adminTitle').val().trim()
        };
      }
    }).then(result => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Adding Admin...',
          html: '<div class="spinner-border text-primary" role="status"></div>',
          allowOutsideClick: false,
          showConfirmButton: false
        });
        
        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            Swal.fire({
              icon: 'success',
              title: 'Admin Added!',
              html: result.value.name + ' has been granted admin access.<br><small class="text-muted">A welcome email with quick start guide has been sent.</small>',
              timer: 3000,
              showConfirmButton: false
            });
            loadAdmins();
          } else {
            Swal.fire('Error', res.error || 'Failed to add admin', 'error');
          }
        }).settingsAddAdmin(APP.token, result.value);
      }
    });
  }).settingsGetDepartments(APP.token);
}

  function delAdmin(row) {
    Swal.fire({
      title: 'Remove Admin Access?',
      text: 'This user will no longer be able to access the system.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Remove',
      confirmButtonColor: '#dc3545'
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            Swal.fire({ icon: 'success', title: 'Admin Removed', timer: 1500, showConfirmButton: false });
            loadAdmins();
          } else {
            Swal.fire('Error', res.error, 'error');
          }
        }).settingsDeleteAdmin(APP.token, row);
      }
    });
  }

  // --- DEPARTMENTS ---
  function loadDepartments() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(d => {
        html += `
          <div class="item-card">
            <div>
              <strong>${esc(d.department)}</strong>
              <div class="small text-muted">
                <i class="fas fa-users mr-1"></i>
                ${d.hrName || 'No HR contact'} • 
                ${d.payrollName || 'No Payroll contact'} • 
                ${d.safetyName || 'No Safety contact'}
              </div>
            </div>
            <div>
              <button class="btn btn-xs btn-outline-primary mr-1" onclick="editDeptContactsUI('${esc(d.department)}')">
                <i class="fas fa-address-book"></i> Contacts
              </button>
              <button class="btn btn-xs btn-outline-danger" onclick="delDept(${d.row})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      $('#deptList').html(html || '<p class="text-muted text-center">No departments configured</p>');
    }).settingsGetDepartments(APP.token);
  }

  function addDeptUI() {
    Swal.fire({
      title: 'Add Department',
      input: 'text',
      inputPlaceholder: 'Department Name',
      showCancelButton: true,
      preConfirm: (val) => {
        if (!val || !val.trim()) {
          Swal.showValidationMessage('Department name required');
          return false;
        }
        return val.trim();
      }
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Department Added', timer: 1500, showConfirmButton: false });
          loadDepartments();
        }).settingsAddDepartment(APP.token, r.value);
      }
    });
  }

  function delDept(row) {
    Swal.fire({
      title: 'Delete Department?',
      text: 'This will remove the department and all associated contacts.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Delete',
      confirmButtonColor: '#dc3545'
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
          loadDepartments();
        }).settingsDeleteDepartment(APP.token, row);
      }
    });
  }

  function editDeptContactsUI(deptName) {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) {
        Swal.fire('Error', res.error, 'error');
        return;
      }
      var c = res.contacts;
      Swal.fire({
        title: 'Department Contacts: ' + deptName,
        width: '800px',
        html: `
          <div class="contact-grid">
            <div class="contact-box">
              <h6>PAO/HR Generalist</h6>
              <input id="hr_name" class="form-control form-control-sm mb-2" placeholder="Name" value="${esc(c['PAO/HR Generalist'].name)}">
              <input id="hr_email" type="email" class="form-control form-control-sm mb-2" placeholder="Email" value="${esc(c['PAO/HR Generalist'].email)}">
              <input id="hr_phone" class="form-control form-control-sm" placeholder="Phone" value="${esc(c['PAO/HR Generalist'].phone)}">
            </div>
            <div class="contact-box">
              <h6>Payroll Specialist</h6>
              <input id="pr_name" class="form-control form-control-sm mb-2" placeholder="Name" value="${esc(c['Payroll Specialist/Manager'].name)}">
              <input id="pr_email" type="email" class="form-control form-control-sm mb-2" placeholder="Email" value="${esc(c['Payroll Specialist/Manager'].email)}">
              <input id="pr_phone" class="form-control form-control-sm" placeholder="Phone" value="${esc(c['Payroll Specialist/Manager'].phone)}">
            </div>
            <div class="contact-box">
              <h6>Safety & Training Officer</h6>
              <input id="sa_name" class="form-control form-control-sm mb-2" placeholder="Name" value="${esc(c['Safety and Training Officer'].name)}">
              <input id="sa_email" type="email" class="form-control form-control-sm mb-2" placeholder="Email" value="${esc(c['Safety and Training Officer'].email)}">
              <input id="sa_phone" class="form-control form-control-sm" placeholder="Phone" value="${esc(c['Safety and Training Officer'].phone)}">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Save Contacts',
        preConfirm: () => {
          return {
            "PAO/HR Generalist": { name: $('#hr_name').val(), email: $('#hr_email').val(), phone: $('#hr_phone').val() },
            "Payroll Specialist/Manager": { name: $('#pr_name').val(), email: $('#pr_email').val(), phone: $('#pr_phone').val() },
            "Safety and Training Officer": { name: $('#sa_name').val(), email: $('#sa_email').val(), phone: $('#sa_phone').val() }
          };
        }
      }).then(r => {
        if (r.isConfirmed) {
          google.script.run.withSuccessHandler(() => {
            Swal.fire({ icon: 'success', title: 'Contacts Saved', timer: 1500, showConfirmButton: false });
            loadDepartments();
          }).settingsSaveDeptContacts(APP.token, deptName, r.value);
        }
      });
    }).settingsGetDeptContacts(APP.token, deptName);
  }

  // --- WORK LOCATIONS ---
  function loadWorkLocs() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(w => {
        html += `<tr>
          <td>${esc(w.workLocation)}</td>
          <td>${esc(w.department)}</td>
          <td class="small text-muted">${w.updated}</td>
          <td>
            <button class="btn btn-xs btn-outline-danger" onclick="delWorkLoc(${w.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`;
      });
      $('#tblWorkLocs tbody').html(html || '<tr><td colspan="4" class="text-center text-muted">No work locations</td></tr>');
    }).settingsGetWorkLocs(APP.token);
  }

  function addWorkLocUI() {
    google.script.run.withSuccessHandler(deptRes => {
      var deptOpts = deptRes.rows.map(d => `<option value="${d.department}">${d.department}</option>`).join('');
      Swal.fire({
        title: 'Add Work Location',
        html: `
          <input id="wl_name" class="swal2-input" placeholder="Location Name">
          <select id="wl_dept" class="swal2-select">
            <option value="">Select Department...</option>
            ${deptOpts}
          </select>
        `,
        showCancelButton: true,
        preConfirm: () => {
          var n = $('#wl_name').val().trim();
          var d = $('#wl_dept').val();
          if (!n || !d) {
            Swal.showValidationMessage('Both fields required');
            return false;
          }
          return { name: n, dept: d };
        }
      }).then(r => {
        if (r.isConfirmed) {
          google.script.run.withSuccessHandler(() => {
            Swal.fire({ icon: 'success', title: 'Location Added', timer: 1500, showConfirmButton: false });
            loadWorkLocs();
          }).settingsAddWorkLoc(APP.token, r.value);
        }
      });
    }).settingsGetDepartments(APP.token);
  }

  function delWorkLoc(row) {
    if (confirm('Delete this work location?')) {
      google.script.run.withSuccessHandler(() => {
        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
        loadWorkLocs();
      }).settingsDeleteWorkLoc(APP.token, row);
    }
  }

  // --- CAUSES ---
  function loadCauses() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(c => {
        html += `
          <div class="item-card">
            <span>${esc(c.cause)}</span>
            <button class="btn btn-xs btn-outline-danger" onclick="delCause(${c.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });
      $('#causeList').html(html || '<p class="text-muted text-center">No causes configured</p>');
    }).settingsGetPrimaryCauses(APP.token);
  }

  function addCauseUI() {
    Swal.fire({
      title: 'Add Primary Cause',
      input: 'text',
      inputPlaceholder: 'e.g., Slip/Trip/Fall',
      showCancelButton: true,
      preConfirm: (val) => {
        if (!val || !val.trim()) {
          Swal.showValidationMessage('Value required');
          return false;
        }
        return val.trim();
      }
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Cause Added', timer: 1500, showConfirmButton: false });
          loadCauses();
        }).settingsAddPrimaryCause(APP.token, r.value);
      }
    });
  }

  function delCause(row) {
    if (confirm('Delete this cause?')) {
      google.script.run.withSuccessHandler(() => {
        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
        loadCauses();
      }).settingsDeletePrimaryCause(APP.token, row);
    }
  }

  // --- TREATMENTS ---
  function loadTreatments() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(t => {
        html += `
          <div class="item-card">
            <span>${esc(t.treatment)}</span>
            <button class="btn btn-xs btn-outline-danger" onclick="delTreatment(${t.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });
      $('#treatmentList').html(html || '<p class="text-muted text-center">No treatments configured</p>');
    }).settingsGetTreatments(APP.token);
  }

  function addTreatmentUI() {
    Swal.fire({
      title: 'Add Treatment Type',
      input: 'text',
      inputPlaceholder: 'e.g., Emergency Room',
      showCancelButton: true,
      preConfirm: (val) => {
        if (!val || !val.trim()) {
          Swal.showValidationMessage('Value required');
          return false;
        }
        return val.trim();
      }
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Treatment Added', timer: 1500, showConfirmButton: false });
          loadTreatments();
        }).settingsAddTreatment(APP.token, r.value);
      }
    });
  }

  function delTreatment(row) {
    if (confirm('Delete this treatment?')) {
      google.script.run.withSuccessHandler(() => {
        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
        loadTreatments();
      }).settingsDeleteTreatment(APP.token, row);
    }
  }

  // --- BODY PARTS ---
  function loadBodyParts() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(b => {
        html += `
          <div class="item-card">
            <span>${esc(b.bodyPart)}</span>
            <button class="btn btn-xs btn-outline-danger" onclick="delBodyPart(${b.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });
      $('#bodyPartList').html(html || '<p class="text-muted text-center">No body parts configured</p>');
    }).settingsGetBodyParts(APP.token);
  }

  function addBodyPartUI() {
    Swal.fire({
      title: 'Add Body Part',
      input: 'text',
      inputPlaceholder: 'e.g., Left Knee',
      showCancelButton: true,
      preConfirm: (val) => {
        if (!val || !val.trim()) {
          Swal.showValidationMessage('Value required');
          return false;
        }
        return val.trim();
      }
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Body Part Added', timer: 1500, showConfirmButton: false });
          loadBodyParts();
        }).settingsAddBodyPart(APP.token, r.value);
      }
    });
  }

  function delBodyPart(row) {
    if (confirm('Delete this body part?')) {
      google.script.run.withSuccessHandler(() => {
        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
        loadBodyParts();
      }).settingsDeleteBodyPart(APP.token, row);
    }
  }

  // --- PROVIDERS ---
  function loadProviders() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(p => {
        var hoursSummary = [];
        var days = [
          { open: p.monOpen, hours: p.monHours, name: 'Mon' },
          { open: p.tueOpen, hours: p.tueHours, name: 'Tue' },
          { open: p.wedOpen, hours: p.wedHours, name: 'Wed' },
          { open: p.thuOpen, hours: p.thuHours, name: 'Thu' },
          { open: p.friOpen, hours: p.friHours, name: 'Fri' },
          { open: p.satOpen, hours: p.satHours, name: 'Sat' },
          { open: p.sunOpen, hours: p.sunHours, name: 'Sun' }
        ];
        days.forEach(d => {
          if (d.open) hoursSummary.push(d.name);
        });
        var hoursText = hoursSummary.length > 0 ? hoursSummary.join(', ') : 'Call for hours';
        
        html += `<tr>
          <td><strong>${esc(p.providerName)}</strong></td>
          <td>${esc(p.address)}</td>
          <td>${esc(p.phone)}</td>
          <td class="small text-muted">${hoursText}</td>
          <td>
            <button class="btn btn-xs btn-outline-danger" onclick="delProvider(${p.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`;
      });
      $('#tblProviders tbody').html(html || '<tr><td colspan="5" class="text-center text-muted">No providers configured</td></tr>');
    }).settingsGetProviders(APP.token);
  }

  function addProviderUI() {
    Swal.fire({
      title: 'Add Treatment Provider',
      width: '700px',
      html: `
        <div class="text-left">
          <div class="form-group">
            <label class="small font-weight-bold">Provider Name *</label>
            <input id="p_name" class="form-control" placeholder="e.g., Maine Medical Center ER">
          </div>
          <div class="form-group">
            <label class="small font-weight-bold">Address *</label>
            <input id="p_addr" class="form-control" placeholder="Street Address, City, State ZIP">
          </div>
          <div class="form-group">
            <label class="small font-weight-bold">Phone</label>
            <input id="p_phone" class="form-control" placeholder="(207) 555-1234">
          </div>
          
          <h6 class="mt-3 mb-2">Hours of Operation</h6>
          <div class="row">
            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
              <div class="col-6 mb-2">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="p_${day.toLowerCase()}_open">
                  <label class="custom-control-label small" for="p_${day.toLowerCase()}_open">${day}</label>
                </div>
                <input id="p_${day.toLowerCase()}_hrs" class="form-control form-control-sm mt-1" placeholder="8am-5pm" disabled>
              </div>
            `).join('')}
          </div>
        </div>
      `,
      didOpen: () => {
        ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(d => {
          $(`#p_${d}_open`).on('change', function() {
            $(`#p_${d}_hrs`).prop('disabled', !this.checked);
          });
        });
      },
      showCancelButton: true,
      confirmButtonText: 'Add Provider',
      preConfirm: () => {
        var name = $('#p_name').val().trim();
        var addr = $('#p_addr').val().trim();
        if (!name || !addr) {
          Swal.showValidationMessage('Provider name and address are required');
          return false;
        }
        return {
          providerName: name,
          address: addr,
          phone: $('#p_phone').val().trim(),
          monOpen: $('#p_mon_open').is(':checked'),
          monHours: $('#p_mon_hrs').val(),
          tueOpen: $('#p_tue_open').is(':checked'),
          tueHours: $('#p_tue_hrs').val(),
          wedOpen: $('#p_wed_open').is(':checked'),
          wedHours: $('#p_wed_hrs').val(),
          thuOpen: $('#p_thu_open').is(':checked'),
          thuHours: $('#p_thu_hrs').val(),
          friOpen: $('#p_fri_open').is(':checked'),
          friHours: $('#p_fri_hrs').val(),
          satOpen: $('#p_sat_open').is(':checked'),
          satHours: $('#p_sat_hrs').val(),
          sunOpen: $('#p_sun_open').is(':checked'),
          sunHours: $('#p_sun_hrs').val()
        };
      }
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Provider Added', timer: 1500, showConfirmButton: false });
          loadProviders();
        }).settingsAddProvider(APP.token, r.value);
      }
    });
  }

  function delProvider(row) {
    Swal.fire({
      title: 'Delete Provider?',
      text: 'This will remove the provider from the directory.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Delete',
      confirmButtonColor: '#dc3545'
    }).then(r => {
      if (r.isConfirmed) {
        google.script.run.withSuccessHandler(() => {
          Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
          loadProviders();
        }).settingsDeleteProvider(APP.token, row);
      }
    });
  }

  function esc(s) {
    return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') : '';
  }

  // --- OPEN SETTINGS MODAL (MAKE GLOBALLY AVAILABLE) ---
   // --- DOCUMENT TYPES ---
  function loadDocumentTypes() {
    google.script.run.withSuccessHandler(res => {
      if (!res.success) return;
      var html = '';
      res.rows.forEach(t => {
        html += `
          <div class="item-card">
            <span>${esc(t.docType)}</span>
            <button class="btn btn-xs btn-outline-danger" onclick="delDocumentType(${t.rowIdx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });
      $('#documentTypeList').html(html || '<p class="text-muted text-center">No document types configured</p>');
    }).settingsGetDocumentTypes(APP.token);
  }

  function addDocumentTypeUI() {
    $('#add_docTypeName').val('');
    $('#addDocumentTypeModal').modal('show');
    $('#addDocumentTypeModal').one('shown.bs.modal', function() {
      $('#add_docTypeName').focus();
    });
  }
  
  function saveDocumentTypeAdd() {
    var name = $('#add_docTypeName').val().trim();
    if (!name) {
      Swal.fire('Required', 'Document type name is required', 'warning');
      return;
    }
    google.script.run.withSuccessHandler(function(res) {
      $('#addDocumentTypeModal').modal('hide');
      if (res.success) {
        Swal.fire({ icon: 'success', title: 'Type Added', timer: 1500, showConfirmButton: false });
        loadDocumentTypes();
      } else {
        Swal.fire('Error', res.error || 'Failed to add type', 'error');
      }
    }).settingsAddDocumentType(APP.token, name);
  }

  function delDocumentType(row) {
    if (confirm('Delete this document type?')) {
      google.script.run.withSuccessHandler(() => {
        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
        loadDocumentTypes();
      }).settingsDeleteDocumentType(APP.token, row);
    }
  }
  window.openSettingsModal = function() {
    $('#settingsModal').modal('show');
    loadSettings();
  };
</script>