<div class="container">
  <div class="row justify-content-center pt-5"> <div class="col-md-5">
      <div class="card border-0 shadow-lg">
        <div class="card-body p-5">
          <div class="text-center mb-4">
            <h3 class="font-weight-bold text-primary">Admin Access</h3>
            <p class="text-muted">Enter your city email to receive a code.</p>
          </div>
          
          <div id="loginStep1">
            <div class="form-group">
              <input type="email" id="loginEmail" class="form-control form-control-lg" placeholder="name@portlandmaine.gov">
            </div>
            <button class="btn btn-primary btn-block btn-lg" onclick="reqCode()">Send Code</button>
          </div>

          <div id="loginStep2" class="d-none">
            <div class="form-group">
              <input type="text" id="loginCode" class="form-control form-control-lg text-center" placeholder="123456" maxlength="6">
            </div>
            <button class="btn btn-success btn-block btn-lg" onclick="verCode()">Verify</button>
            <button class="btn btn-link btn-block" onclick="backToEmail()">Back</button>
          </div>
          
          <div id="loginMsg" class="mt-3 text-center text-danger small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function reqCode() {
    var email = $('#loginEmail').val();
    if(!email) return;
    $('#loginMsg').text('');
    var btn = event.target; var txt = btn.innerText; btn.innerText='Sending...'; btn.disabled=true;

    google.script.run.withSuccessHandler(function(res){
      btn.innerText=txt; btn.disabled=false;
      if(res.success) { $('#loginStep1').addClass('d-none'); $('#loginStep2').removeClass('d-none'); } 
      else { $('#loginMsg').text(res.error); }
    }).requestAuthCode(email);
  }

  function verCode() {
    var email = $('#loginEmail').val();
    var code = $('#loginCode').val();
    var btn = event.target; var txt = btn.innerText; btn.innerText='Verifying...'; btn.disabled=true;

    google.script.run.withSuccessHandler(function(res){
      btn.innerText=txt; btn.disabled=false;
      if(res.success) {
        APP.token = res.token; APP.user = res.user; APP.reports = res.data;
        sessionStorage.setItem('FROI_SESSION', JSON.stringify(res));
        initApp(); 
      } else { $('#loginMsg').text(res.error); }
    }).verifyAndGetData(email, code);
  }

  function backToEmail() { $('#loginStep2').addClass('d-none'); $('#loginStep1').removeClass('d-none'); $('#loginMsg').text(''); }
</script>