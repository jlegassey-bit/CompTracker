<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f0f2f5; font-family: system-ui, sans-serif; }
    
    /* Sidebar Styles */
    .sidebar { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px; position: sticky; top: 20px; }
    .nav-link { color: #495057; font-weight: 600; border-radius: 8px; padding: 10px 15px; margin-bottom: 5px; cursor: pointer; }
    .nav-link.active { background-color: #e7f1ff; color: #0056b3; }
    .nav-link:hover { background-color: #f8f9fa; }
    
    .main-content { min-height: 80vh; }
    
    /* View Switching Utilities */
    .view-section { display: none; }
    .view-section.active { display: block; }
  </style>
</head>
<body>

  <div id="appLoading" class="text-center pt-5 mt-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 text-muted">Loading Portal...</div>
  </div>

  <div id="viewLogin" class="view-section">
    <?!= include('View_AdminLogin'); ?>
  </div>

  <div id="viewApp" class="view-section container-fluid py-4">
    <div class="row">
      
      <div class="col-md-2 d-none d-md-block">
        <div class="sidebar">
          <h5 class="font-weight-bold mb-4 px-3" style="color:#0f3b67;">FROI Admin</h5>
          
          <div class="nav flex-column nav-pills" id="mainNav">
          <a class="nav-link active" onclick="showSection('cases', this)">
              <i class="fas fa-list mr-2"></i>Cases
            </a>
            <a class="nav-link" onclick="showSection('dashboard', this)">
              <i class="fas fa-chart-line mr-2"></i>Dashboard
            </a>
            <a class="nav-link" onclick="showSection('settings', this)">
              <i class="fas fa-cogs mr-2"></i>Settings
            </a>
          </div>
          
          <hr>
          <div class="px-3 mb-3">
            <small class="text-muted">Logged in as:</small><br>
            <strong id="userNameDisplay">Admin</strong>
          </div>
          <button class="btn btn-sm btn-outline-danger btn-block" onclick="logout()">Log Out</button>
        </div>
      </div>

      <div class="col-md-10 main-content">
        
      <div id="section-cases">
          <?!= include('View_AdminDashboard'); ?>
        </div>
        
        <div id="section-dashboard" class="d-none">
          <?!= include('View_Dashboard'); ?>
        </div>

        <div id="section-settings" class="d-none">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h4 class="mb-4 text-primary font-weight-bold">System Configuration</h4>
              <p class="text-muted">Manage Admins, Departments, Dropdown Lists, and Provider details.</p>
              
              <div class="alert alert-info border-0 shadow-sm mb-4">
                <i class="fas fa-info-circle mr-2"></i>
                Settings changes take effect immediately for all users.
              </div>

              <button class="btn btn-primary btn-lg shadow-sm" onclick="openSettingsModal()">
                <i class="fas fa-sliders-h mr-2"></i>Open Settings Manager
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <?!= include('Modal_CaseDetail'); ?>
  <?!= include('Modal_Settings'); ?>

  <script>
    // GLOBAL APP STATE
    var APP = {
      token: null,
      user: null,
      reports: [] 
    };

    $(function() {
      // Check for existing session
      var session = sessionStorage.getItem('FROI_SESSION');
      if (session) {
        try {
          var data = JSON.parse(session);
          APP.token = data.token;
          APP.user = data.user;
          APP.reports = data.reports || [];
          initApp();
        } catch(e) { showLogin(); }
      } else {
        showLogin();
      }
    });

    function showLogin() {
      $('#appLoading').hide(); 
      $('#viewApp').removeClass('active');
      $('#viewLogin').addClass('active');
      
      // Ensure the inner container in View_AdminLogin is visible
      $('#viewLogin .container').removeClass('d-none');
    }

    function initApp() {
  $('#appLoading').hide();
  $('#viewLogin').removeClass('active');
  $('#viewApp').addClass('active');
  
  $('#userNameDisplay').text((APP.user && APP.user.name) ? APP.user.name : 'Admin');
  
  // Initialize Dashboard Grid if the function exists
  if(typeof renderCaseGrid === 'function') renderCaseGrid(); 
}

    function logout() {
      sessionStorage.removeItem('FROI_SESSION');
      location.reload();
    }

    // FIXED: Now accepts 'element' to correctly handle active state
 function showSection(id, element) {
      $('#mainNav .nav-link').removeClass('active');
      if(element) {
        $(element).addClass('active');
      }

      if(id === 'cases') {
        $('#section-cases').removeClass('d-none');
        $('#section-dashboard').addClass('d-none');
        $('#section-settings').addClass('d-none');
      } else if (id === 'dashboard') {
        $('#section-cases').addClass('d-none');
        $('#section-dashboard').removeClass('d-none');
        $('#section-settings').addClass('d-none');
        if (typeof loadDashboard === 'function') {
          loadDashboard();
        }
      } else if (id === 'settings') {
        $('#section-cases').addClass('d-none');
        $('#section-dashboard').addClass('d-none');
        $('#section-settings').removeClass('d-none');
      }
    }
    
    function currentEmail() { return APP.user ? APP.user.email : ''; }
  </script>
</body>
</html>